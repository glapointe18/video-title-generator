<script>
const form = document.getElementById('titleForm');
const previewsContainer = document.getElementById('previewsContainer');
const addTitleBtn = document.getElementById('addTitleBtn');
const titlesContainer = document.getElementById('titlesContainer');
const colorPaletteDiv = document.getElementById('colorPalette');
const customColorInput = document.getElementById('customColor');

const paletteColors = ['#fff2cc', '#ffb1b7', '#7c67ff', '#ffffff', '#ff7456'];
let selectedColor = '#ffffff';

// Generate swatches
paletteColors.forEach((color) => {
  const swatch = document.createElement('div');
  swatch.className = 'colorSwatch';
  swatch.style.background = color;
  swatch.dataset.color = color;
  if(color === '#ffffff') swatch.classList.add('selected'); // default white
  colorPaletteDiv.insertBefore(swatch, customColorInput);
});

// Handle swatch click
function selectColor(colorDiv, color) {
  document.querySelectorAll('.colorSwatch, #customColor').forEach(el => el.classList.remove('selected'));
  colorDiv.classList.add('selected');
  selectedColor = color;
}
document.querySelectorAll('.colorSwatch').forEach(swatch => {
  swatch.addEventListener('click', () => selectColor(swatch, swatch.dataset.color));
});

// Custom color
customColorInput.addEventListener('input', () => selectColor(customColorInput, customColorInput.value));

// Add new title block
addTitleBtn.addEventListener('click', () => {
  const newBlock = document.createElement('div');
  newBlock.className = 'titleBlock';
  newBlock.innerHTML = `
    <label>Titre :</label><input type="text" class="videoTitle" placeholder="Ex: Sonate n°5">
    <label>Opera / Source :</label><input type="text" class="operaSource" placeholder="Ex: La Traviata">
    <label>Compositeur :</label><input type="text" class="composer" placeholder="Ex: Beethoven">
  `;
  titlesContainer.appendChild(newBlock);
  attachLivePreview(newBlock);
});

// Live preview for all blocks
function attachLivePreview(block) {
  const videoTitleInput = block.querySelector('.videoTitle');
  const operaInput = block.querySelector('.operaSource');
  const composerInput = block.querySelector('.composer');

  const previewDiv = document.createElement('div');
  previewDiv.className = 'preview';
  previewDiv.style.color = selectedColor;
  previewsContainer.appendChild(previewDiv);

  function updatePreview() {
    const interpreter = document.getElementById('interpreter').value;
    const instrumentTessiture = document.getElementById('instrumentTessiture').value;
    const accompanist = document.getElementById('accompanist').value;
    const instrumentAccomp = document.getElementById('instrumentAccomp').value;
    const fontChoice = document.getElementById('fontChoice').value;
    const fontStyle = document.getElementById('fontStyle').value;

    previewDiv.style.color = selectedColor;
    previewDiv.style.fontFamily = fontChoice;
    previewDiv.style.fontStyle = fontStyle.includes('italic') ? 'italic':'normal';
    previewDiv.style.fontWeight = fontStyle.includes('bold') ? 'bold':'normal';

    let secondLine = '';
    if(operaInput.value) secondLine += `<div style="font-size:42px; font-weight:normal;">${operaInput.value}</div>`;
    if(composerInput.value) secondLine += `<div style="font-size:42px; font-weight:normal;">${composerInput.value}</div>`;

    previewDiv.innerHTML = `
      <div style="font-size:42px; font-weight:bold; font-style:italic;">${videoTitleInput.value}</div>
      ${secondLine}<br><br>
      <div style="font-size:31px;">${[interpreter, instrumentTessiture].filter(Boolean).join(', ')}</div>
      <div style="font-size:31px;">${[accompanist, instrumentAccomp].filter(Boolean).join(', ')}</div>
      <button class="download-btn">Télécharger cette page</button>
    `;

    const downloadBtn = previewDiv.querySelector('button');
    downloadBtn.addEventListener('click', ()=>{
      html2canvas(previewDiv, { scale: 5 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `page-titre-${Array.from(previewsContainer.children).indexOf(previewDiv)+1}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  }

  // Update on input changes
  [videoTitleInput, operaInput, composerInput].forEach(input => input.addEventListener('input', updatePreview));
  ['interpreter','instrumentTessiture','accompanist','instrumentAccomp','fontChoice','fontStyle'].forEach(id => 
    document.getElementById(id).addEventListener('input', updatePreview)
  );
  customColorInput.addEventListener('input', updatePreview);
  document.querySelectorAll('.colorSwatch').forEach(swatch => swatch.addEventListener('click', updatePreview));

  updatePreview(); // initial
}

// Attach live preview to initial block
document.querySelectorAll('.titleBlock').forEach(block => attachLivePreview(block));

// Form submit to regenerate previews (optional, can keep it if needed)
form.addEventListener('submit', (e) => e.preventDefault());
</script>
