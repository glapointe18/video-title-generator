<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Générateur de Pages Titres</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cinzel+Decorative&family=Gilda+Display&family=Montserrat&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Montserrat', sans-serif;
        background-color: #121212;
        color: white;
        padding: 20px;
    }
    .container {
        max-width: 800px;
        margin: auto;
        background: #1c1c1c;
        padding: 20px;
        border-radius: 10px;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
    }
    .piece-container {
        background: #2a2a2a;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
    }
    #preview {
        background: black;
        margin-top: 20px;
        padding: 50px;
        text-align: center;
        color: white;
        width: 3840px;
        height: 2160px;
        display: none;
    }
    .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        margin: 5px;
        border: 2px solid white;
    }
</style>
</head>
<body>

<div class="container">
    <h1>Générateur de Pages Titres</h1>
    <form id="titleForm">
        <label for="font">Police :</label>
        <select id="font">
            <option value="'Gilda Display', serif">Gilda Display</option>
            <option value="'Cinzel Decorative', cursive">Cinzel Decorative</option>
            <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
            <option value="'Montserrat', sans-serif">Montserrat</option>
        </select>

        <label>Couleur du texte :</label>
        <div>
            <span class="color-option" style="background:#fff2cc;" data-color="#fff2cc"></span>
            <span class="color-option" style="background:#ffb1b7;" data-color="#ffb1b7"></span>
            <span class="color-option" style="background:#7c67ff;" data-color="#7c67ff"></span>
            <span class="color-option" style="background:#ffffff;" data-color="#ffffff"></span>
            <span class="color-option" style="background:#ff7456;" data-color="#ff7456"></span>
            <input type="color" id="customColor" style="margin-left:10px;">
        </div>

        <label for="interprete">Interprète :</label>
        <input type="text" id="interprete" required>

        <label for="accompagnement">Accompagnement :</label>
        <input type="text" id="accompagnement" placeholder="Ex: Piano, Orchestre">

        <h3>Pièces (Titre / Opéra / Compositeur)</h3>
        <div id="pieces"></div>
        <button type="button" onclick="addPiece()">Ajouter une pièce</button><br><br>

        <button type="button" onclick="generatePages()">Générer les pages</button>
        <button type="button" onclick="sendEmail()">Envoyer par Email</button>
        <button type="button" onclick="downloadZIP()">Télécharger en ZIP</button>
    </form>
</div>

<div id="preview"></div>

<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
(function(){
    emailjs.init("TJWO-d6xGHgV93CjR"); // Your EmailJS public key
})();

let selectedColor = "#ffffff";
let generatedImages = [];

document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
        selectedColor = this.dataset.color;
    });
});

document.getElementById('customColor').addEventListener('change', function() {
    selectedColor = this.value;
});

function addPiece() {
    const container = document.createElement('div');
    container.classList.add('piece-container');
    container.innerHTML = `
        <label>Titre :</label><input type="text" class="title" required>
        <label>Opéra (optionnel) :</label><input type="text" class="opera">
        <label>Compositeur :</label><input type="text" class="composer" required>
    `;
    document.getElementById('pieces').appendChild(container);
}

function generatePages() {
    generatedImages = [];
    const font = document.getElementById('font').value;
    const interprete = document.getElementById('interprete').value;
    const accompagnement = document.getElementById('accompagnement').value;
    const pieces = document.querySelectorAll('.piece-container');
    const preview = document.getElementById('preview');

    pieces.forEach((piece, index) => {
        const title = piece.querySelector('.title').value;
        const opera = piece.querySelector('.opera').value;
        const composer = piece.querySelector('.composer').value;

        let html = `
            <div style="font-family:${font};color:${selectedColor};width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                <div style="font-size:42px;font-weight:bold;font-style:italic;">${title}</div>
                ${opera ? `<div style="font-size:42px;margin-top:10px;">${opera}</div>` : ""}
                <div style="font-size:42px;margin-top:10px;">${composer}</div>
                <div style="height:60px;"></div>
                <div style="font-size:31px;">${interprete}</div>
                <div style="font-size:31px;">${accompagnement}</div>
            </div>
        `;
        preview.innerHTML = html;
        preview.style.display = 'block';

        const canvas = document.createElement('canvas');
        canvas.width = 3840;
        canvas.height = 2160;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const data = new XMLSerializer().serializeToString(preview);
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="3840" height="2160"><foreignObject width="100%" height="100%">${data}</foreignObject></svg>`;
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
            generatedImages.push({ name: `page_${index+1}.png`, data: canvas.toDataURL("image/png") });
        };
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    });
}

async function downloadZIP() {
    if (generatedImages.length === 0) {
        alert("Veuillez générer les pages avant de télécharger.");
        return;
    }

    const zip = new JSZip();
    generatedImages.forEach(img => {
        const base64Data = img.data.split(',')[1];
        zip.file(img.name, base64Data, { base64: true });
    });

    const content = await zip.generateAsync({ type: "blob" });
    saveAs(content, "pages_titres.zip");
}

async function sendEmail() {
    if (generatedImages.length === 0) {
        alert("Veuillez générer les pages avant d'envoyer.");
        return;
    }

    try {
        await emailjs.send("service_bfuvp9i", "template_f8oe7vt", {
            to_email: "glapointe@prodgetl.com",
            form_html: document.getElementById('titleForm').outerHTML,
            images: JSON.stringify(generatedImages.map(img => img.name))
        });
        alert("Email envoyé avec succès (sans images, utilisez ZIP pour fichiers) !");
    } catch (error) {
        console.error("Erreur lors de l'envoi :", error);
        alert("Échec de l'envoi.");
    }
}
</script>

</body>
</html>
