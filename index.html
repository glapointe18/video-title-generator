<script>
const form = document.getElementById('titleForm');
const previewsContainer = document.getElementById('previewsContainer');
const addTitleBtn = document.getElementById('addTitleBtn');
const titlesContainer = document.getElementById('titlesContainer');
const colorPaletteDiv = document.getElementById('colorPalette');
const customColorInput = document.getElementById('customColor');

const paletteColors = ['#fff2cc', '#ffb1b7', '#7c67ff', '#ffffff', '#ff7456'];
let selectedColor = '#ffffff';

// Generate swatches
paletteColors.forEach((color) => {
  const swatch = document.createElement('div');
  swatch.className = 'colorSwatch';
  swatch.style.background = color;
  swatch.dataset.color = color;
  if(color === '#ffffff') swatch.classList.add('selected'); // default white
  colorPaletteDiv.insertBefore(swatch, customColorInput);
});

// Handle swatch click
const colorSwatches = document.querySelectorAll('.colorSwatch');
colorSwatches.forEach(swatch => {
  swatch.addEventListener('click', () => {
    colorSwatches.forEach(s => s.classList.remove('selected'));
    swatch.classList.add('selected');
    selectedColor = swatch.dataset.color;
  });
});

// Custom color
customColorInput.addEventListener('change', () => {
  colorSwatches.forEach(s => s.classList.remove('selected'));
  selectedColor = customColorInput.value;
});

addTitleBtn.addEventListener('click', () => {
  const newBlock = document.createElement('div');
  newBlock.className = 'titleBlock';
  newBlock.innerHTML = `
    <label>Titre :</label><input type="text" class="videoTitle" placeholder="Ex: Sonate n°5">
    <label>Opera / Source :</label><input type="text" class="operaSource" placeholder="Ex: La Traviata">
    <label>Compositeur :</label><input type="text" class="composer" placeholder="Ex: Beethoven">
  `;
  titlesContainer.appendChild(newBlock);
});

form.addEventListener('submit', (e) => {
  e.preventDefault();
  previewsContainer.innerHTML = ''; // Clear previous previews

  const interpreter = document.getElementById('interpreter').value;
  const instrumentTessiture = document.getElementById('instrumentTessiture').value;
  const accompanist = document.getElementById('accompanist').value;
  const instrumentAccomp = document.getElementById('instrumentAccomp').value;
  const fontChoice = document.getElementById('fontChoice').value;
  const fontStyle = document.getElementById('fontStyle').value;

  const titleBlocks = titlesContainer.querySelectorAll('.titleBlock');

  titleBlocks.forEach((block,index)=>{
    const videoTitle = block.querySelector('.videoTitle').value;
    const operaSource = block.querySelector('.operaSource').value;
    const composer = block.querySelector('.composer').value;

    if(!videoTitle) return;

    // Preview box
    const previewDiv = document.createElement('div');
    previewDiv.className = 'preview';
    previewDiv.style.color = selectedColor;
    previewDiv.style.fontFamily = fontChoice;
    previewDiv.style.fontStyle = fontStyle==='italic' ? 'italic':'normal';
    previewDiv.style.fontWeight = fontStyle==='bold' ? 'bold':'normal';

    let secondLine = '';
    if(operaSource) secondLine += `<div style="font-size:42px; font-weight:normal;">${operaSource}</div>`;
    if(composer) secondLine += `<div style="font-size:42px; font-weight:normal;">${composer}</div>`;

    previewDiv.innerHTML = `
      <div style="font-size:42px; font-weight:bold; font-style:italic;">${videoTitle}</div>
      ${secondLine}<br><br>
      <div style="font-size:31px;">${[interpreter, instrumentTessiture].filter(Boolean).join(', ')}</div>
      <div style="font-size:31px;">${[accompanist, instrumentAccomp].filter(Boolean).join(', ')}</div>
    `;

    // Download button OUTSIDE preview
    const downloadBtn = document.createElement('button');
    downloadBtn.textContent = 'Télécharger cette page';
    downloadBtn.className = 'download-btn';

    downloadBtn.addEventListener('click', ()=>{
      html2canvas(previewDiv, { scale: 5 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `page-titre-${index+1}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    // Wrapper for spacing
    const wrapperDiv = document.createElement('div');
    wrapperDiv.style.marginBottom = '30px';
    wrapperDiv.appendChild(previewDiv);
    wrapperDiv.appendChild(downloadBtn);

    previewsContainer.appendChild(wrapperDiv);
  });
});
</script>
