<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Créateur de Pages Titre Illimitées</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cinzel+Decorative&family=Gilda+Display&family=Lobster&family=Montserrat&family=Playfair+Display&family=Roboto+Slab&display=swap" rel="stylesheet">

<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  h1 { margin-bottom: 20px; }
  form { margin-bottom: 20px; max-width: 600px; }
  input, select, button { display: block; margin-bottom: 10px; padding: 8px; width: 100%; }
  .preview {
    width: 800px; height: 450px; border: 2px solid #333; 
    display: flex; flex-direction: column; justify-content: center; 
    align-items: center; text-align: center; 
    background-color: black; position: relative; margin-bottom: 20px; padding: 10px;
    color: white;
  }
  #colorPalette { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
  .colorSwatch { width:40px; height:40px; cursor:pointer; border:2px solid #333; border-radius:5px; }
  .colorSwatch.selected { border:3px solid #fff; }
  #customColorBtn { padding:5px 10px; cursor:pointer; }
</style>
</head>
<body>

<h1>Créer des Pages Titre Illimitées</h1>
<form id="titleForm">

  <h2>Informations des artistes (inchangées)</h2>
  <label>Interprète :</label>
  <input type="text" id="interpreter" required placeholder="Ex: John Doe">

  <label>Instrument / Tessiture :</label>
  <input type="text" id="instrumentTessiture" placeholder="Ex: Piano, Soprano">

  <label>Accompagnateur :</label>
  <input type="text" id="accompanist" placeholder="Ex: Jane Smith">

  <label>Instrument Accompagnateur :</label>
  <input type="text" id="instrumentAccomp" placeholder="Ex: Piano">

  <label>Text color :</label>
  <div id="colorPalette">
    <button type="button" id="customColorBtn">Custom Color</button>
    <input type="color" id="customColor" style="display:none;">
  </div>

  <label>Choix de police :</label>
  <select id="fontChoice">
    <option value="'Gilda Display', serif">Gilda Display</option>
    <option value="'Cinzel Decorative', cursive">Cinzel Decorative</option>
    <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
    <option value="'Montserrat', sans-serif">Montserrat</option>
    <option value="'Lobster', cursive">Lobster</option>
    <option value="'Roboto Slab', serif">Roboto Slab</option>
    <option value="'Playfair Display', serif">Playfair Display</option>
  </select>

  <h2>Titres / Opéra / Compositeur (illimité)</h2>
  <div id="titlesContainer">
    <div class="titleBlock">
      <label>Titre :</label><input type="text" class="videoTitle" placeholder="Ex: Sonate n°5">
      <label>Opera / Source :</label><input type="text" class="operaSource" placeholder="Ex: La Traviata">
      <label>Compositeur :</label><input type="text" class="composer" placeholder="Ex: Beethoven">
    </div>
  </div>
  <button type="button" id="addTitleBtn">Ajouter un autre titre</button>
  <button type="button" id="generateBtn">Générer les pages</button>
  <button type="button" id="sendEmailBtn">Envoyer par Email</button>
</form>

<div id="previewsContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const paletteColors = ['#fff2cc', '#ffb1b7', '#7c67ff', '#ffffff', '#ff7456'];
let selectedColor = '#ffffff';
const colorPaletteDiv = document.getElementById('colorPalette');
const customColorInput = document.getElementById('customColor');
const customColorBtn = document.getElementById('customColorBtn');

// Generate color swatches
paletteColors.forEach(color => {
  const swatch = document.createElement('div');
  swatch.className = 'colorSwatch';
  swatch.style.background = color;
  swatch.dataset.color = color;
  if(color === '#ffffff') swatch.classList.add('selected');
  colorPaletteDiv.insertBefore(swatch, customColorBtn);
});

const colorSwatches = document.querySelectorAll('.colorSwatch');
colorSwatches.forEach(swatch => {
  swatch.addEventListener('click', () => {
    colorSwatches.forEach(s => s.classList.remove('selected'));
    swatch.classList.add('selected');
    selectedColor = swatch.dataset.color;
  });
});

// Custom color
customColorBtn.addEventListener('click', () => customColorInput.click());
customColorInput.addEventListener('change', () => {
  colorSwatches.forEach(s => s.classList.remove('selected'));
  selectedColor = customColorInput.value;
});

// Add new title block
document.getElementById('addTitleBtn').addEventListener('click', () => {
  const newBlock = document.createElement('div');
  newBlock.className = 'titleBlock';
  newBlock.innerHTML = `
    <label>Titre :</label><input type="text" class="videoTitle" placeholder="Ex: Sonate n°5">
    <label>Opera / Source :</label><input type="text" class="operaSource" placeholder="Ex: La Traviata">
    <label>Compositeur :</label><input type="text" class="composer" placeholder="Ex: Beethoven">
  `;
  document.getElementById('titlesContainer').appendChild(newBlock);
});

// Generate previews
document.getElementById('generateBtn').addEventListener('click', () => {
  const previewsContainer = document.getElementById('previewsContainer');
  previewsContainer.innerHTML = '';
  const interpreter = document.getElementById('interpreter').value;
  const instrumentTessiture = document.getElementById('instrumentTessiture').value;
  const accompanist = document.getElementById('accompanist').value;
  const instrumentAccomp = document.getElementById('instrumentAccomp').value;
  const fontChoice = document.getElementById('fontChoice').value;

  const titleBlocks = document.querySelectorAll('.titleBlock');
  titleBlocks.forEach((block, idx) => {
    const videoTitle = block.querySelector('.videoTitle').value;
    const operaSource = block.querySelector('.operaSource').value;
    const composer = block.querySelector('.composer').value;
    if(!videoTitle) return;

    const previewDiv = document.createElement('div');
    previewDiv.className = 'preview';
    previewDiv.style.color = selectedColor;
    previewDiv.style.fontFamily = fontChoice;

    let secondLine = '';
    if(operaSource) secondLine += `<div style="font-size:42px; font-weight:normal;">${operaSource}</div>`;
    if(composer) secondLine += `<div style="font-size:42px; font-weight:normal;">${composer}</div>`;

    previewDiv.innerHTML = `
      <div style="font-size:42px; font-weight:bold; font-style:italic;">${videoTitle}</div>
      ${secondLine}<br><br>
      <div style="font-size:31px;">${[interpreter, instrumentTessiture].filter(Boolean).join(', ')}</div>
      <div style="font-size:31px;">${[accompanist, instrumentAccomp].filter(Boolean).join(', ')}</div>
    `;
    previewsContainer.appendChild(previewDiv);
  });
});

// Send email
document.getElementById('sendEmailBtn').addEventListener('click', async () => {
  const previews = document.querySelectorAll('.preview');
  if(previews.length === 0) return alert("Générez d'abord les pages.");

  const images = [];
  for(const preview of previews){
    const canvas = await html2canvas(preview, { scale: 5 });
    images.push(canvas.toDataURL('image/png'));
  }

  const formHTML = document.getElementById('titleForm').outerHTML;

  try {
    const res = await fetch('http://localhost:3000/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ images, formHTML })
    });

    const data = await res.json();
    if(data.success){
      alert("Email envoyé avec succès !");
    } else {
      alert("Erreur lors de l'envoi : " + data.error);
    }
  } catch(err) {
    console.error(err);
    alert("Erreur de connexion au serveur");
  }
});
</script>
</body>
</html>
